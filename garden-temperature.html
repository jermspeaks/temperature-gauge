<link rel='import' href='../polymer/polymer.html'>

<!--
`garden-temperature`
# Temperature gauge

## Reusable element for Grow IoT

### Dependencies

- [d3](https://github.com/d3/d3)

### Caveats
Only works with Fahrenheit for now

@demo demo/index.html
-->

<dom-module id='garden-temperature'>
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Temperature Gauge Element</h2>
    <svg id='gardentemperature'>
      <defs>
        <linearGradient id='temp-gradient' x1='0%' y1='0%' x2='100%' y2='0%'>
          <stop offset='0%' style='stop-color:[[colorCold]];stop-opacity:1' />
          <stop offset='50%' style='stop-color:#fff;stop-opacity:0' />
          <stop offset='100%' style='stop-color:[[colorHot]];stop-opacity:1' />
        </linearGradient>
      </defs>
    </svg>
  </template>
  <script src='../d3/d3.js'></script>
  <!-- Bower doesn't bundle these for some reason -->
  <!-- <script src='https://d3js.org/d3-color.v0.5.min.js'></script> -->
  <!-- <script src='https://d3js.org/d3-interpolate.v0.9.min.js'></script>
  <script src='https://d3js.org/d3-scale-chromatic.v0.3.min.js'></script> -->

  <script>
    Polymer({

      is: 'garden-temperature',

      properties: {
        /**
         * Temperature for gauge.
         *
         * **Note** If temperature is less than 0째F,
         * the needle will move beyond the gauge.
         * Likewise for above 1000째F
         */
        temperature: {
          type: Number,
          value: 65
        },
        /**
         * Width of SVG container
         */
        chartWidth: {
          type: Number,
          value: 300
        },
        /**
         * Height of SVG container
         */
        chartHeight: {
          type: Number,
          value: 300
        },
        /**
         * Size of the inner radius of the gauge
         */
        innerRadius: {
          type: Number,
          value: 60
        },
        /**
         * Size of the outer radius of the gauge
         */
        outerRadius: {
          type: Number,
          value: 120
        },
        /**
         * Center of the gauge on the X-Axis
         */
        chartXCenter: {
          type: Number,
          value: 150
        },
        /**
         * Center of the gauge on the Y-Axis
         */
        chartYCenter: {
          type: Number,
          value: 150
        },
        /**
         * Color for the left side of linear gradient
         */
        colorCold: {
          type: String,
          value: '#7dace7'
        },
        /**
         * Color for the right side of linear gradient
         */
        colorHot: {
          type: String,
          value: '#e7827d'
        }
      },
      /**
       * Create elements for charts
       */
      createElements: function() {
        // Chart Constants
        const CORNER_RADIUS = 1;
        const PAD_ANGLE = 0;
        const DOMAIN = [0, 100];
        const RANGE = [-45, 225];

        // SVG Container attributes
        this.svg = d3.select(this.$.gardentemperature)
          .attr('width', this.chartWidth)
          .attr('height', this.chartHeight);

        this.arc = d3.arc()
          .innerRadius(this.innerRadius)
          .outerRadius(this.outerRadius)
          .cornerRadius(CORNER_RADIUS)
          .padAngle(PAD_ANGLE);

        this.textArc = d3.arc()
          .outerRadius(this.outerRadius);

        this.chartCenter = `translate(${this.chartXCenter},${this.chartYCenter})`;

        this.tempScale = d3.scaleLinear().domain(DOMAIN).range(RANGE);
      },
      /**
       * Draws the chart
       */
      drawChart: function () {
        var self = this;
        var gauge = self.makeGaugeData();
        var temp = self.getData();
        var ticks = self.makeTicks();

        self.pie = d3.pie()
          .startAngle( -(3 * Math.PI) / 4 )
          .endAngle( (3 * Math.PI) / 4 )
          .value(d => d);

        self.groupArcs = self.svg.append('g')
          .attr('class', 'arcs-group');

        self.arcs = self.groupArcs.selectAll( '.arc' )
          .data(self.pie([1])) // Create only one arc
          .enter()
          .append('path')
          .attr('transform', self.chartCenter)
          .attr('d', self.arc)
          .attr('stroke', '#000')
          .attr('stroke-width', '1px')
          .style('fill', 'url(#temp-gradient)');

        self.groupTicks = self.svg.append('g')
          .attr('class', 'ticks-group')
          .selectAll('g')
          .data(d3.range(-45, 245, 27))
          .enter()
          .append('g')
          .attr('transform', d => `${self.chartCenter} rotate(${-d})`);

        self.groupTicks.append('text')
          .attr('x', self.outerRadius + 6)
          .attr('dy', '.35em')
          .style('text-anchor', d => d < 270 && d > 90 ? 'end' : null)
          .attr('transform', d => {
            if (d < 270 && d > 90) {
              return 'rotate(180 ' + (self.outerRadius + 6) + ',0)';
            } else {
              return null;
            }
          })
          .text((d, i) => ((11 - (i + 1)) * 10) + '째F');

        self.groupTicks.append('line')
          .attr('x1', self.innerRadius)
          .attr('x2', self.outerRadius)
          .attr('y1', 0)
          .attr('y2', 0)
          .style('fill', 'none')
          .style('stroke', '#777')
          .style('stroke-dasharray', '1,4');

        self.needle = self.svg.selectAll('.needle')
          .data(temp)
          .enter()
          .append('line')
          .attr('x1', 0)
          .attr('x2', -115)
          .attr('y1', 0)
          .attr('y2', 0)
          .style('stroke', 'black')
          .attr('transform', d => `${self.chartCenter} rotate(${self.tempScale(d)})`);

        self.tempText = self.svg.append('text')
          .attr('class', 'temp-text')
          .style('font-size', '32px')
          .attr('transform', d => `translate(${self.chartXCenter},${self.chartYCenter + self.innerRadius})`)
          .attr('text-anchor', 'middle')
          .text(() => parseFloat(temp, 10).toFixed(0).toString() + '째F');
      },
      /**
       * Creates Gauge Data
       * @param  {Number} N   Number of splits in gauge
       * @return {array}      Array of numbers as value equal to 1
       */
      makeGaugeData: function(N) {
        var elements;
        if (N) {
          elements = N;
        } else {
          elements = 10;
        }

        return Array.apply(null, { length: elements }).map(Number.call, Number).map(() => 1);
      },
      /**
       * Creates list for ticks
       * @return {array} list of temperatures for tick marks
       */
      makeTicks: function() {
        return Array.apply(null, { length: 10 }).map(Number.call, Number).map(num => (num + 1) * 10);
      },
      /**
       * Gets data from properties and places it in an array
       * @return {array} Tempature Data in a list
       */
      getData: function() {
        // This is the getter for the data
        return [this.temperature];
      },
      ready: function () {
        this.createElements();
        this.drawChart();
        // this.getData();
      },

    });
  </script>
</dom-module>
